# 代码规范

> 本文件为 predict_withdraw 项目的 C++ 编码约定，供开发与 code review 参考。

---

## 1. 命名约定

| 类别 | 风格 | 示例 |
|------|------|------|
| 类 / 结构体 | `PascalCase` | `StockDataManager`, `TdfMsgData` |
| 成员变量 | `m_camelCase` | `m_flagOrder`, `m_sumAmountRaw` |
| 局部变量 | `snake_case` 或 `camelCase` | `item_count`, `pAppHead` |
| 方法 | `camelCase` | `processOrder()`, `setWhitelist()` |
| 常量 | `kCamelCase` 或 `UPPER_SNAKE` | `kCapacity`, `kThreshold50wRaw` |
| 枚举值 | `UPPER_SNAKE` | `WAIT_NEW_ACK`, `IDLE` |
| 文件名 | `snake_case` | `stock_data_manager.cpp` |
| 头文件宏 | `UPPER_SNAKE_H` | `#ifndef MSG_QUEUE_H` |

---

## 2. 价格与金额（整数运算）

- **价格 raw** = `price_元 × 10000`（TDF 字段 `nPrice` 类型为 `__int64`，即 raw）
- **金额 raw** = `price_raw × volume`
- **阈值**：50 万 = `500000LL * 10000LL`
- **1.07 触发**：使用整数比较 `tick_raw * 100 > base_raw * 107`，**避免 `double` 比较**
- **涨停价倒推基准价**（tick 单位）：
  ```cpp
  base_tick = llround(limitup_tick / 1.1 + 1e-6);
  base_raw  = base_tick * 100;
  ```
- 仅在 SECITPDK 接口参数处将 raw 转 `double`

---

## 3. 线程安全规则

### 3.1 不可做

- ❌ 行情回调线程中调用交易 API（`SECITPDK_OrderEntrust` 等）
- ❌ 多线程并发调用 `MsgQueue::push()`（SPSC 假设）
- ❌ 在启动完成后向 `StockDataManagerFactory` 插入新 manager

### 3.2 锁使用

- `StockDataManager::m_mutex`：保护 per-symbol 状态，当前保留（即使处理线程单线程）
- `OrderManagerWithdraw::m_mutex`：保护消息队列 + 触发队列 + 状态机
- `StockDataManagerFactory`：启动后 `m_readOnlyAfterInit = true`，运行期 `getStockManager()` 跳过锁
- 新增原子变量优先使用 `memory_order_relaxed`，除非需要 happens-before 保证

### 3.3 SPSC ring buffer 约束

- `m_write_index`：仅生产者线程写、消费者线程读
- `m_read_index`：仅消费者线程写、生产者线程读
- 多 item 写入先写 slot 再 **一次性** `store(release)` 推进 `m_write_index`

---

## 4. 日志规范

### 4.1 日志前缀

| 前缀 | 含义 |
|------|------|
| `[LIMITUP_SELL_50W]` | 50 万阈值触发 |
| `[LUP_ORDER_SEND]` | 发送涨停价卖单 |
| `[LUP_ORDER_ACK]` | 新单确认回报 |
| `[LUP_CANCEL_SEND]` | 发送撤单 |
| `[LUP_CANCEL_ACK]` | 撤单确认回报 |
| `[LUP_CANCEL_INVALID]` | 撤单废单 |
| `[MSG_QUEUE_STATS]` | 队列深度/丢包统计（每 2 秒） |
| `[MSG_QUEUE_DROP]` | ORDER/TRANSACTION 丢包告警 |
| `[MSG_QUEUE_DROP_OVERSIZE]` | 单条数据超过 slot 容量 |

### 4.2 级别使用

- `info`：正常业务事件（触发、确认、统计）
- `warn`：可恢复异常（丢包、重试）
- `error`：需要人工介入的问题（连接失败、下单失败）
- **不要用 `error` 记录正常信息**

### 4.3 性能

- 热路径（每笔行情）避免 flush
- 关键节点（下单/撤单/触发/状态转换）可 flush
- 统计日志按间隔输出，避免逐条打印

---

## 5. 沪深逐笔字段差异速查

详见 [字段说明.md](字段说明.md)。关键速记：

| 操作 | 上海 (SH) | 深圳 (SZ) |
|------|-----------|-----------|
| 委托方向 | `TDF_ORDER.chFunctionCode` = `'B'`/`'S'` | 同左 |
| **撤单识别** | ORDER 流 `chOrderKind == 'D'` | TRANSACTION 流 `chFunctionCode == 'C'` |
| 成交方向 | `TDF_TRANSACTION.nBSFlag` = `'B'`/`'S'` | 同左 |
| 卖方委托号 | `TDF_TRANSACTION.nAskOrder` | 同左 |

---

## 6. 文件组织

- 每个逻辑模块一对 `.h` + `.cpp`
- 头文件使用 `#ifndef` / `#define` 守卫（不用 `#pragma once`，gcc 4.8 兼容考虑；`stdafx.h` 例外）
- 第三方头文件放 `include/` 子目录
- 辅助工具放 `tools/`
- 设计文档放 `docs/`，按版本号命名（`design-v0/v1/v2-...`）
