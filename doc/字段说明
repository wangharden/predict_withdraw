已选中后台终端输出

数据非常清晰了！让我停止程序并总结结果。 

Ran terminal command: Stop-Process -Name "TDFDataReceiver_CSV_history" -Force -ErrorAction SilentlyContinue

已完成: *编译并运行程序* (3/3)

程序已成功运行并获取到了大量逐笔委托和成交数据。**你的记忆是对的！** 上海市场撤单确实是看 `OrderKind == 'D'`。

## 运行结果总结

### 上海市场 (.SH) 逐笔委托 — `OrderKind` 字段含义

| OrderKind | 含义 | 示例 |
|-----------|------|------|
| **`'A'` (0x41)** | 新增委托 (Add) | 买入/卖出下单 |
| **`'D'` (0x44)** | **撤单 (Delete)** ★ | 撤销之前的委托 |
| **`'S'` (0x53)** | 状态标识 (Status) | 开盘/收盘等市场状态 |

### `FunctionCode` 字段含义
- `'B'` (0x42) = **买入** (Buy)
- `'S'` (0x53) = **卖出** (Sell)
- `'O'` (0x4f) = **开盘** (Open，配合 OrderKind='S' 使用)

### 撤单示例（从实际数据中捕获）
```
603506.SH 09:19:40 | OrderKind: 'D' | FunctionCode: 'S' | OrigOrderNo: 131148  → 撤销卖单
605287.SH 09:30:03 | OrderKind: 'D' | FunctionCode: 'B' | OrigOrderNo: 66139   → 撤销买单
603363.SH 09:30:03 | OrderKind: 'D' | FunctionCode: 'S' | OrigOrderNo: 295700  → 撤销卖单
```

### 逐笔成交
- 上海市场的逐笔成交中 `OrderKind` 和 `FunctionCode` 都为 `0x0`（空），不填充这两个字段
- 买卖方向通过 `BSFlag` 标识（66='B'买, 83='S'卖, 32=' '集合竞价无方向）

### 结论
- **上海撤单判断：`chOrderKind == 'D'`** ✅（你说的完全正确）
- 之前提到的 `FunctionCode == 'C'` 在头文件注释中虽有标注，但实际数据中上海市场并不使用 `'C'`，而是用 `OrderKind='D'` 表示撤单，`FunctionCode` 保留原始买卖方向





 

## 📊 上海 vs 深圳 逐笔数据字段对比

### 一、逐笔委托 (`TDF_ORDER`) 字段差异

| 字段 | 上海 (SH) | 深圳 (SZ) |
|---|---|---|
| **`chOrderKind`** | `'A'`=新增, **`'D'`=撤单**, `'S'`=状态 | 始终为 `'0'`(0x30)，无区分 |
| **`chFunctionCode`** | `'B'`=买入, `'S'`=卖出 | `'B'`=买入, `'S'`=卖出 |
| **`nOrderOriNo`** | 非零（原始委托号） | 始终为 **0** |
| **`nBizIndex`** | 非零（业务编号=委托号） | 始终为 **0** |

### 二、逐笔成交 (`TDF_TRANSACTION`) 字段差异

| 字段 | 上海 (SH) | 深圳 (SZ) |
|---|---|---|
| **`chOrderKind`** | 空 `''`(0x0) | `'0'`(0x30) |
| **`chFunctionCode`** | 空 `''`(0x0) | `'0'`=正常成交, **`'C'`=撤单** |
| **`nBSFlag`** | 66(`B`买入), 83(`S`卖出) | 66(`B`买入), 83(`S`卖出), 32(集合竞价/撤单) |
| **`nBizIndex`** | 非零 | 始终为 **0** |

### 三、🔑 撤单识别方法（核心差异）

| 市场 | 撤单判断方式 | 出现位置 |
|---|---|---|
| **上海** | 逐笔**委托**中 `chOrderKind == 'D'` | `MSG_DATA_ORDER` |
| **深圳** | 逐笔**成交**中 `chFunctionCode == 'C'` | `MSG_DATA_TRANSACTION` |

### 四、深圳撤单成交的特征

从实测数据可以看到，SZ 撤单成交记录有以下特征：
- 价格 = **0**，成交额 = **0**
- `FunctionCode = 'C'`(0x43)
- `BSFlag = 32`（集合竞价标记）
- `nAskOrder = 0`（叫卖方为空，仅有叫买方）

### 五、实测数据示例

**SH 撤单（逐笔委托）：**
> `605006.SH | OrderKind: 'D'(0x44)[撤单] | FuncCode: 'B'(0x42)[买入] | OrigOrd:490209`

**SZ 撤单（逐笔成交）：**
> `000070.SZ | 价: 0 | 量: 55500 | BSFlag: 32 | FuncCode: 'C'(0x43) | 叫卖#0 | 叫买#546845 ★★★撤单成交`

---

**结论：** 你的印象完全正确——上海看 `OrderKind=='D'`。而深圳的撤单机制完全不同，它**不在逐笔委托中体现撤单**（OrderKind 始终为 `'0'`），而是在**逐笔成交**流中以 `FunctionCode=='C'` 来标识撤销/撤回的订单。

已进行更改。


